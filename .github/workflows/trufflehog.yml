name: TruffleHog Secret Scan 🔎 🔒

on:
  pull_request:
    branches:
      - main

jobs:
  trufflehog_scan:
    runs-on: ubuntu-latest
    if: |
      always() &&
      (inputs.DISABLE_TruffleHog == false) &&
      (needs.build.result == 'success') &&
      (github.event_name == 'pull_request')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Get Changed Files
        run: |
          BASE_SHA=$(git merge-base origin/${{ github.base_ref }} HEAD)
          HEAD_SHA="${{ github.sha }}"
          echo "BASE_SHA=$BASE_SHA"
          echo "HEAD_SHA=$HEAD_SHA"
          echo "CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Run TruffleHog on PR Changed Files
        id: trufflehog_scan
        run: |
          EXIT_CODE=0
          SCAN_RESULTS=""
          SECRET_FOUND=false
          for file in $CHANGED_FILES; do
            echo "Scanning $file..."
            RESULT=$(trufflehog filesystem --no-verification "$file" 2>&1 || true)
            echo "$RESULT"
            SCAN_RESULTS+="$RESULT"$'\n\n'
            if echo "$RESULT" | grep -q 'Reason:'; then
              SECRET_FOUND=true
              EXIT_CODE=1
            fi
          done
          echo "SECRET_FOUND=$SECRET_FOUND" >> $GITHUB_ENV
          echo "SCAN_OUTPUT=$SCAN_RESULTS" >> $GITHUB_ENV
          echo "$SCAN_RESULTS" > scan_results.txt
          exit $EXIT_CODE

      - name: Upload Scan Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-Scan-Results
          path: scan_results.txt
          retention-days: 5

      - name: Comment on PR with Scan Results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "🔍 **TruffleHog Scan Results** 🔍

          - ✅ Scan **Completed**
          - 🚀 Repository: ${{ github.repository }}
          - 📄 Files Scanned: ${{ env.CHANGED_FILES }}

          **Results:**
          ${{ env.SECRET_FOUND == 'true' && '- ❌ Secrets detected! Workflow failed to prevent merging. Please rotate secrets and address the issue.' || '- ✅ No secrets found!' }}

          **Scan Details:** [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          ${{ env.SECRET_FOUND == 'true' && '\n**Scan Output:**\n```\n' + env.SCAN_OUTPUT + '\n```' || '' }}"
